name: USD-COP Web Scraper

on:
  schedule:
    # Ejecutar todos los dÃ­as a las 10:00 PM hora Colombia (3:00 AM UTC)
    # Colombia estÃ¡ en UTC-5, por lo que 10:00 PM = 3:00 AM UTC del dÃ­a siguiente
    - cron: '0 3 * * *'
  
  # Permite ejecutar manualmente desde GitHub
  workflow_dispatch:

jobs:
  scrape-usd-cop:
    runs-on: ubuntu-latest
    
    steps:
    - name: ğŸ“¥ Checkout cÃ³digo
      uses: actions/checkout@v4
    
    - name: ğŸ Configurar Python 3.11
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
    
    - name: ğŸ“¦ Instalar dependencias Python
      run: |
        python -m pip install --upgrade pip
        pip install -r requirements.txt
    
    - name: ğŸŒ Configurar Chrome para Selenium
      uses: browser-actions/setup-chrome@v1
      with:
        chrome-version: stable
    
    - name: ğŸ“Š Ejecutar scraper USD-COP
      run: |
        echo "ğŸš€ Iniciando scraper a las $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "ğŸ‡¨ğŸ‡´ Hora Colombia aproximada: $(TZ='America/Bogota' date '+%Y-%m-%d %H:%M:%S')"
        python usd_cop_scraper.py
      
    - name: ğŸ“ Verificar archivos generados
      run: |
        echo "ğŸ“‹ Archivos generados:"
        ls -la *.xlsx *.csv *.json 2>/dev/null || echo "âš ï¸  No se encontraron archivos"
        
        if [ -f "forecast_usd.xlsx" ]; then
          echo "âœ… Excel file created: forecast_usd.xlsx"
          ls -lh forecast_usd.xlsx
        fi
        
        if [ -f "forecast_usd.csv" ]; then
          echo "âœ… CSV file created: forecast_usd.csv"
          head -5 forecast_usd.csv
        fi
    
    - name: ğŸ“¤ Subir archivos como artifacts
      uses: actions/upload-artifact@v3
      if: always()
      with:
        name: usd-cop-forecast-${{ github.run_number }}
        path: |
          forecast_usd.xlsx
          forecast_usd.csv
          forecast_usd_*.json
        retention-days: 30
    
    - name: ğŸ“§ Notificar resultados (opcional)
      if: always()
      run: |
        if [ ${{ job.status }} == 'success' ]; then
          echo "âœ… Scraping completado exitosamente"
          echo "ğŸ“Š Datos de USD-COP actualizados"
          echo "ğŸ“… Fecha: $(TZ='America/Bogota' date '+%Y-%m-%d %H:%M:%S Colombia')"
        else
          echo "âŒ Scraping fallÃ³"
          echo "ğŸ”§ Revisar logs para mÃ¡s detalles"
        fi

  # Job adicional para mostrar informaciÃ³n del sistema (debugging)
  system-info:
    runs-on: ubuntu-latest
    if: github.event_name == 'workflow_dispatch'  # Solo cuando se ejecuta manualmente
    
    steps:
    - name: ğŸ–¥ï¸ InformaciÃ³n del sistema
      run: |
        echo "ğŸ§ Sistema operativo:"
        lsb_release -a
        echo ""
        echo "ğŸŒ Zona horaria:"
        timedatectl
        echo ""
        echo "ğŸ• Hora actual:"
        echo "UTC: $(date -u)"
        echo "Colombia: $(TZ='America/Bogota' date)"
        echo ""
        echo "ğŸŒ Conectividad:"
        curl -I https://30rates.com/usd-cop || echo "âŒ No se puede conectar al sitio"
